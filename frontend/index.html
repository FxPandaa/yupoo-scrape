<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yupoo Search Engine - FashionReps</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì¶</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #0a0a0a; color: #ededed; }
        .product-card { transition: transform 0.2s, box-shadow 0.2s; }
        .product-card:hover { transform: translateY(-4px); box-shadow: 0 10px 40px rgba(0,0,0,0.4); }
        ::-webkit-scrollbar { width: 8px; } 
        ::-webkit-scrollbar-track { background: #1a1a1a; } 
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        .no-image { display: flex; align-items: center; justify-content: center; color: #555; font-size: 3rem; }
        .tab-active { border-color: #f97316; color: white; }
        .tab-inactive { border-color: transparent; color: #6b7280; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="min-h-screen">
    <div id="app">
        <!-- Header -->
        <header class="bg-[#111] border-b border-gray-800 sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex items-center justify-between gap-4 flex-wrap">
                    <div class="flex items-center gap-3">
                        <svg class="w-8 h-8 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                        <div>
                            <h1 class="text-xl font-bold text-white">Yupoo Search</h1>
                            <p id="stats-text" class="text-xs text-gray-500">Loading...</p>
                        </div>
                    </div>
                    
                    <form id="search-form" class="flex-1 max-w-2xl">
                        <div class="relative">
                            <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            <input type="text" id="search-input" placeholder="Search products, brands, sellers..." class="w-full pl-12 pr-4 py-3 bg-[#1a1a1a] border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-orange-500">
                        </div>
                    </form>
                    
                    <div class="flex items-center gap-3">
                        <button id="filter-btn" class="flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-700 text-gray-300 hover:border-gray-600">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
                            Filters
                        </button>
                        <button id="automation-btn" class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-purple-600 to-orange-500 hover:from-purple-500 hover:to-orange-400 rounded-lg text-white font-medium">
                            <svg id="automation-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            <span id="automation-text">Start Auto</span>
                        </button>
                    </div>
                </div>
                
                <!-- Tabs -->
                <div class="flex gap-6 mt-4 border-b border-gray-800">
                    <button id="tab-products" class="tab-active pb-3 px-1 text-sm font-medium border-b-2 transition-colors">
                        üì¶ Products
                    </button>
                    <button id="tab-status" class="tab-inactive pb-3 px-1 text-sm font-medium border-b-2 transition-colors hover:text-gray-300">
                        ‚ö° Status Dashboard
                    </button>
                    <button id="tab-discovered" class="tab-inactive pb-3 px-1 text-sm font-medium border-b-2 transition-colors hover:text-gray-300">
                        üîç New Sellers <span id="discovered-count" class="ml-1 px-1.5 py-0.5 bg-purple-600 rounded-full text-xs">0</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex gap-6">
                <!-- Filters sidebar -->
                <aside id="filters-sidebar" class="hidden w-64 flex-shrink-0">
                    <div class="bg-[#111] rounded-xl border border-gray-800 p-4 sticky top-36">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="font-semibold text-white">Filters</h2>
                            <button id="clear-filters" class="text-sm text-orange-500 hover:text-orange-400">Clear all</button>
                        </div>
                        
                        <div class="border-b border-gray-800 pb-4 mb-4">
                            <label class="block text-sm font-medium text-gray-400 mb-2">Seller</label>
                            <select id="seller-filter" class="w-full bg-[#1a1a1a] border border-gray-700 rounded-lg px-3 py-2 text-white text-sm">
                                <option value="">All sellers</option>
                            </select>
                        </div>
                        
                        <div class="border-b border-gray-800 pb-4 mb-4">
                            <label class="block text-sm font-medium text-gray-400 mb-2">Category</label>
                            <select id="category-filter" class="w-full bg-[#1a1a1a] border border-gray-700 rounded-lg px-3 py-2 text-white text-sm">
                                <option value="">All categories</option>
                            </select>
                        </div>
                        
                        <div class="border-b border-gray-800 pb-4 mb-4">
                            <label class="block text-sm font-medium text-gray-400 mb-2">Brand</label>
                            <select id="brand-filter" class="w-full bg-[#1a1a1a] border border-gray-700 rounded-lg px-3 py-2 text-white text-sm">
                                <option value="">All brands</option>
                            </select>
                        </div>
                        
                        <div class="border-b border-gray-800 pb-4 mb-4">
                            <label class="block text-sm font-medium text-gray-400 mb-2">Price (¬•)</label>
                            <div class="flex gap-2">
                                <input type="number" id="min-price" placeholder="Min" class="w-1/2 bg-[#1a1a1a] border border-gray-700 rounded-lg px-3 py-2 text-white text-sm">
                                <input type="number" id="max-price" placeholder="Max" class="w-1/2 bg-[#1a1a1a] border border-gray-700 rounded-lg px-3 py-2 text-white text-sm">
                            </div>
                        </div>
                        
                        <!-- Has Purchase Links Filter -->
                        <div class="border-b border-gray-800 pb-4 mb-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="has-links-filter" class="w-4 h-4 rounded bg-[#1a1a1a] border-gray-700 text-orange-500 focus:ring-orange-500">
                                <span class="text-sm text-gray-400">Only with buy links</span>
                                <span class="text-xs text-green-500">üõí</span>
                            </label>
                            <p class="text-xs text-gray-600 mt-1">Weidian / Taobao / 1688</p>
                        </div>
                        
                        <button id="apply-filters" class="w-full bg-orange-500 hover:bg-orange-400 text-white py-2 rounded-lg font-medium">Apply Filters</button>
                    </div>
                </aside>

                <!-- Main content -->
                <main class="flex-1">
                    <!-- Products Tab -->
                    <div id="products-tab" class="tab-content">
                        <div class="flex items-center justify-between mb-4">
                            <p id="results-text" class="text-gray-400">Loading...</p>
                        </div>

                        <div id="loading" class="flex items-center justify-center py-20">
                            <svg class="w-8 h-8 text-orange-500 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        </div>

                        <div id="products-grid" class="hidden grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>

                        <div id="empty-state" class="hidden text-center py-20">
                            <svg class="w-16 h-16 text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                            <h3 class="text-xl font-semibold text-white mb-2">No products found</h3>
                            <p class="text-gray-500 mb-4">Try adjusting your search or filters, or start automation to scrape sellers</p>
                        </div>

                        <div id="pagination" class="hidden flex items-center justify-center gap-4 mt-8">
                            <button id="prev-btn" class="flex items-center gap-2 px-4 py-2 bg-[#1a1a1a] border border-gray-700 rounded-lg text-white disabled:opacity-50">‚Üê Previous</button>
                            <span id="page-info" class="text-gray-400">Page 1 of 1</span>
                            <button id="next-btn" class="flex items-center gap-2 px-4 py-2 bg-[#1a1a1a] border border-gray-700 rounded-lg text-white disabled:opacity-50">Next ‚Üí</button>
                        </div>
                    </div>
                    
                    <!-- Status Dashboard Tab -->
                    <div id="status-tab" class="tab-content hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div class="bg-[#111] border border-gray-800 rounded-xl p-4">
                                <p class="text-gray-500 text-sm">Total Products</p>
                                <p id="stat-products" class="text-2xl font-bold text-white">0</p>
                            </div>
                            <div class="bg-[#111] border border-gray-800 rounded-xl p-4">
                                <p class="text-gray-500 text-sm">With Buy Links</p>
                                <p id="stat-links" class="text-2xl font-bold text-green-400">0</p>
                            </div>
                            <div class="bg-[#111] border border-gray-800 rounded-xl p-4">
                                <p class="text-gray-500 text-sm">Sellers Scraped</p>
                                <p id="stat-sellers" class="text-2xl font-bold text-blue-400">0</p>
                            </div>
                            <div class="bg-[#111] border border-gray-800 rounded-xl p-4">
                                <p class="text-gray-500 text-sm">New Sellers Found</p>
                                <p id="stat-discovered" class="text-2xl font-bold text-purple-400">0</p>
                            </div>
                        </div>
                        
                        <!-- Automation Status -->
                        <div id="automation-status" class="bg-[#111] border border-gray-800 rounded-xl p-6 mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-white">Automation Status</h3>
                                <span id="automation-badge" class="px-3 py-1 rounded-full text-sm bg-gray-700 text-gray-300">Idle</span>
                            </div>
                            
                            <div id="automation-idle" class="text-center py-8">
                                <p class="text-gray-500 mb-4">Click "Start Auto" to begin automated discovery and scraping</p>
                                <p class="text-xs text-gray-600">This will: discover sellers from Reddit ‚Üí scrape all sellers ‚Üí find buy links</p>
                            </div>
                            
                            <div id="automation-running" class="hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <!-- Discovery Progress -->
                                    <div class="bg-[#1a1a1a] rounded-lg p-4">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span id="discovery-indicator" class="w-2 h-2 rounded-full bg-gray-500"></span>
                                            <span class="text-sm font-medium text-gray-300">Reddit Discovery</span>
                                        </div>
                                        <p id="discovery-status" class="text-xs text-gray-500">Waiting...</p>
                                        <div class="mt-2 flex items-center gap-2">
                                            <div class="flex-1 bg-gray-700 rounded-full h-2">
                                                <div id="discovery-progress" class="bg-purple-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                                            </div>
                                            <span id="discovery-count" class="text-xs text-gray-400">0/6</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Scraping Progress -->
                                    <div class="bg-[#1a1a1a] rounded-lg p-4">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span id="scraping-indicator" class="w-2 h-2 rounded-full bg-gray-500"></span>
                                            <span class="text-sm font-medium text-gray-300">Scraping Sellers</span>
                                        </div>
                                        <p id="scraping-status" class="text-xs text-gray-500">Waiting...</p>
                                        <div class="mt-2 flex items-center gap-2">
                                            <div class="flex-1 bg-gray-700 rounded-full h-2">
                                                <div id="scraping-progress" class="bg-orange-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                                            </div>
                                            <span id="scraping-count" class="text-xs text-gray-400">0/0</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-500">Runtime: <span id="runtime" class="text-white">0s</span></span>
                                    <span class="text-gray-500">Products found: <span id="products-found" class="text-green-400">0</span></span>
                                    <span class="text-gray-500">Albums checked: <span id="albums-checked" class="text-blue-400">0</span></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recent Errors -->
                        <div id="errors-section" class="hidden bg-[#111] border border-red-800 rounded-xl p-4">
                            <h4 class="text-red-400 font-medium mb-2">Recent Errors</h4>
                            <ul id="errors-list" class="text-xs text-red-300 space-y-1 max-h-32 overflow-y-auto"></ul>
                        </div>
                    </div>
                    
                    <!-- Discovered Sellers Tab -->
                    <div id="discovered-tab" class="tab-content hidden">
                        <div class="flex items-center justify-between mb-4">
                            <p class="text-gray-400">Sellers discovered from Reddit - automatically added and scraped</p>
                        </div>
                        
                        <div id="discovered-loading" class="hidden flex items-center justify-center py-20">
                            <svg class="w-8 h-8 text-purple-500 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        </div>
                        
                        <div id="discovered-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                        
                        <div id="discovered-empty" class="hidden text-center py-20">
                            <svg class="w-16 h-16 text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                            <h3 class="text-xl font-semibold text-white mb-2">No discovered sellers yet</h3>
                            <p class="text-gray-500">Start automation to discover sellers from Reddit</p>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let currentPage = 1;
        let totalPages = 1;
        let currentTab = 'products';
        let automationRunning = false;
        let statusPollInterval = null;

        // Elements
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const filterBtn = document.getElementById('filter-btn');
        const filtersSidebar = document.getElementById('filters-sidebar');
        const automationBtn = document.getElementById('automation-btn');
        const productsGrid = document.getElementById('products-grid');
        const loading = document.getElementById('loading');
        const emptyState = document.getElementById('empty-state');
        const pagination = document.getElementById('pagination');

        // Tab switching
        document.getElementById('tab-products').addEventListener('click', () => switchTab('products'));
        document.getElementById('tab-status').addEventListener('click', () => switchTab('status'));
        document.getElementById('tab-discovered').addEventListener('click', () => switchTab('discovered'));
        
        function switchTab(tab) {
            currentTab = tab;
            
            ['products', 'status', 'discovered'].forEach(t => {
                document.getElementById(`tab-${t}`).className = t === tab 
                    ? 'tab-active pb-3 px-1 text-sm font-medium border-b-2 transition-colors' 
                    : 'tab-inactive pb-3 px-1 text-sm font-medium border-b-2 transition-colors hover:text-gray-300';
                document.getElementById(`${t}-tab`).classList.toggle('hidden', t !== tab);
            });
            
            if (tab === 'status') {
                pollAutomationStatus();
            } else if (tab === 'discovered') {
                fetchDiscoveredSellers();
            }
        }

        // Fetch products
        async function fetchProducts() {
            loading.classList.remove('hidden');
            productsGrid.classList.add('hidden');
            emptyState.classList.add('hidden');

            const params = new URLSearchParams();
            if (searchInput.value) params.set('q', searchInput.value);
            if (document.getElementById('seller-filter').value) params.set('seller', document.getElementById('seller-filter').value);
            if (document.getElementById('category-filter').value) params.set('category', document.getElementById('category-filter').value);
            if (document.getElementById('brand-filter').value) params.set('brand', document.getElementById('brand-filter').value);
            if (document.getElementById('min-price').value) params.set('min_price', document.getElementById('min-price').value);
            if (document.getElementById('max-price').value) params.set('max_price', document.getElementById('max-price').value);
            if (document.getElementById('has-links-filter').checked) params.set('has_links', 'true');
            params.set('page', currentPage);
            params.set('per_page', 48);

            try {
                const res = await fetch(`${API_BASE}/search?${params}`);
                const data = await res.json();

                loading.classList.add('hidden');

                if (data.products && data.products.length > 0) {
                    renderProducts(data.products);
                    productsGrid.classList.remove('hidden');
                    totalPages = data.total_pages || 1;
                    updatePagination(data.total);
                } else {
                    emptyState.classList.remove('hidden');
                    document.getElementById('results-text').textContent = '0 products found';
                }

                if (data.facets) updateFacets(data.facets);
            } catch (err) {
                console.error('Search error:', err);
                loading.classList.add('hidden');
                emptyState.classList.remove('hidden');
            }
        }

        // Render products
        function renderProducts(products) {
            productsGrid.innerHTML = products.map(p => {
                const proxyUrl = p.image_url ? `${API_BASE}/image?url=${encodeURIComponent(p.image_url)}` : null;
                const hasWeidian = p.weidian_url;
                const hasTaobao = p.taobao_url;
                const hasPurchase = p.purchase_url;
                
                let badge = '';
                if (hasWeidian) badge = '<div class="absolute top-2 left-2 bg-orange-500 text-white px-2 py-0.5 rounded-full text-xs font-medium">Weidian</div>';
                else if (hasTaobao) badge = '<div class="absolute top-2 left-2 bg-red-500 text-white px-2 py-0.5 rounded-full text-xs font-medium">Taobao</div>';
                else if (hasPurchase) badge = '<div class="absolute top-2 left-2 bg-blue-500 text-white px-2 py-0.5 rounded-full text-xs font-medium">1688</div>';
                
                let buyBtn = '';
                if (hasWeidian) buyBtn = `<a href="${p.weidian_url}" target="_blank" class="p-3 bg-orange-500 hover:bg-orange-400 rounded-full" title="Weidian"><svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></a>`;
                else if (hasTaobao) buyBtn = `<a href="${p.taobao_url}" target="_blank" class="p-3 bg-red-500 hover:bg-red-400 rounded-full" title="Taobao"><svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></a>`;
                else if (hasPurchase) buyBtn = `<a href="${p.purchase_url}" target="_blank" class="p-3 bg-blue-500 hover:bg-blue-400 rounded-full" title="Buy"><svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></a>`;
                
                return `
                <div class="product-card bg-[#111] border border-gray-800 rounded-xl overflow-hidden group">
                    <div class="relative aspect-square bg-[#1a1a1a]">
                        ${proxyUrl ? `<img src="${proxyUrl}" alt="${p.title}" class="w-full h-full object-cover" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\\'no-image w-full h-full\\'>üì¶</div>';">` : '<div class="no-image w-full h-full">üì¶</div>'}
                        ${p.price ? `<div class="absolute top-2 right-2 bg-green-500 text-white px-2 py-0.5 rounded-full text-xs font-medium">¬•${p.price}</div>` : ''}
                        ${badge}
                        <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                            <a href="${p.url}" target="_blank" class="p-3 bg-white/20 hover:bg-white/30 rounded-full" title="Yupoo"><svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg></a>
                            ${buyBtn}
                        </div>
                    </div>
                    <div class="p-3">
                        <h3 class="text-sm text-white font-medium line-clamp-2 mb-2">${p.title}</h3>
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-500">${p.seller}</span>
                            ${p.brand ? `<span class="text-xs text-blue-400">${p.brand}</span>` : ''}
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // Automation control
        async function toggleAutomation() {
            if (automationRunning) {
                // Stop
                try {
                    await fetch(`${API_BASE}/automation/stop`, { method: 'POST' });
                } catch (e) {}
            } else {
                // Start
                try {
                    await fetch(`${API_BASE}/automation/start?discover_reddit=true&scrape_existing=true&scrape_discovered=true&check_buy_links=true&max_pages=20`, { method: 'POST' });
                    switchTab('status');
                } catch (e) {
                    console.error('Start error:', e);
                }
            }
            pollAutomationStatus();
        }
        
        // Poll automation status
        async function pollAutomationStatus() {
            try {
                const res = await fetch(`${API_BASE}/automation/status`);
                const data = await res.json();
                
                updateStatusUI(data);
                
                if (data.is_running) {
                    automationRunning = true;
                    automationBtn.querySelector('#automation-text').textContent = 'Stop';
                    automationBtn.querySelector('#automation-icon').classList.add('animate-pulse');
                    
                    // Continue polling
                    if (!statusPollInterval) {
                        statusPollInterval = setInterval(pollAutomationStatus, 2000);
                    }
                } else {
                    automationRunning = false;
                    automationBtn.querySelector('#automation-text').textContent = 'Start Auto';
                    automationBtn.querySelector('#automation-icon').classList.remove('animate-pulse');
                    
                    if (statusPollInterval) {
                        clearInterval(statusPollInterval);
                        statusPollInterval = null;
                    }
                }
            } catch (e) {
                console.error('Status poll error:', e);
            }
        }
        
        function updateStatusUI(data) {
            // Update stats
            document.getElementById('stat-products').textContent = (data.total_products || 0).toLocaleString();
            document.getElementById('stat-links').textContent = (data.scraping?.products_with_links || 0).toLocaleString();
            document.getElementById('stat-sellers').textContent = data.scraping?.sellers_done || 0;
            document.getElementById('stat-discovered').textContent = data.discovery?.new_sellers || 0;
            
            // Update badge
            const badge = document.getElementById('automation-badge');
            if (data.is_running) {
                badge.textContent = 'Running';
                badge.className = 'px-3 py-1 rounded-full text-sm bg-green-600 text-white pulse';
                document.getElementById('automation-idle').classList.add('hidden');
                document.getElementById('automation-running').classList.remove('hidden');
            } else {
                badge.textContent = 'Idle';
                badge.className = 'px-3 py-1 rounded-full text-sm bg-gray-700 text-gray-300';
                document.getElementById('automation-idle').classList.remove('hidden');
                document.getElementById('automation-running').classList.add('hidden');
            }
            
            // Discovery progress
            const disc = data.discovery || {};
            const discIndicator = document.getElementById('discovery-indicator');
            if (disc.is_running) {
                discIndicator.className = 'w-2 h-2 rounded-full bg-purple-500 pulse';
                document.getElementById('discovery-status').textContent = `Scanning r/${disc.current_subreddit || '...'}`;
            } else if (disc.subreddits_checked > 0) {
                discIndicator.className = 'w-2 h-2 rounded-full bg-green-500';
                document.getElementById('discovery-status').textContent = `Complete - Found ${disc.sellers_found} sellers`;
            } else {
                discIndicator.className = 'w-2 h-2 rounded-full bg-gray-500';
                document.getElementById('discovery-status').textContent = 'Waiting...';
            }
            const discProgress = (disc.subreddits_checked / (disc.total_subreddits || 6)) * 100;
            document.getElementById('discovery-progress').style.width = `${discProgress}%`;
            document.getElementById('discovery-count').textContent = `${disc.subreddits_checked || 0}/${disc.total_subreddits || 6}`;
            
            // Scraping progress
            const scrape = data.scraping || {};
            const scrapeIndicator = document.getElementById('scraping-indicator');
            if (scrape.is_running) {
                scrapeIndicator.className = 'w-2 h-2 rounded-full bg-orange-500 pulse';
                document.getElementById('scraping-status').textContent = `Scraping: ${scrape.current_seller || '...'}`;
            } else if (scrape.sellers_done > 0) {
                scrapeIndicator.className = 'w-2 h-2 rounded-full bg-green-500';
                document.getElementById('scraping-status').textContent = `Complete - ${scrape.products_found} products`;
            } else {
                scrapeIndicator.className = 'w-2 h-2 rounded-full bg-gray-500';
                document.getElementById('scraping-status').textContent = 'Waiting...';
            }
            const scrapeProgress = scrape.total_sellers > 0 ? (scrape.sellers_done / scrape.total_sellers) * 100 : 0;
            document.getElementById('scraping-progress').style.width = `${scrapeProgress}%`;
            document.getElementById('scraping-count').textContent = `${scrape.sellers_done || 0}/${scrape.total_sellers || 0}`;
            
            // Runtime
            document.getElementById('runtime').textContent = data.runtime_formatted || '0s';
            document.getElementById('products-found').textContent = (scrape.products_found || 0).toLocaleString();
            document.getElementById('albums-checked').textContent = (scrape.albums_checked_for_links || 0).toLocaleString();
            
            // Errors
            if (scrape.errors && scrape.errors.length > 0) {
                document.getElementById('errors-section').classList.remove('hidden');
                document.getElementById('errors-list').innerHTML = scrape.errors.slice(-10).map(e => `<li>${e}</li>`).join('');
            } else {
                document.getElementById('errors-section').classList.add('hidden');
            }
        }

        // Fetch discovered sellers
        async function fetchDiscoveredSellers() {
            const gridEl = document.getElementById('discovered-grid');
            const emptyEl = document.getElementById('discovered-empty');
            
            try {
                const res = await fetch(`${API_BASE}/discover/sellers?limit=100`);
                const data = await res.json();
                
                document.getElementById('discovered-count').textContent = data.total || 0;
                
                if (data.sellers && data.sellers.length > 0) {
                    gridEl.innerHTML = data.sellers.map(s => `
                        <div class="bg-[#111] border border-gray-800 rounded-xl p-4">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-medium text-white">${s.yupoo_user}</h3>
                                <span class="text-xs px-2 py-1 rounded ${s.verified ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'}">${s.verified ? '‚úì Verified' : 'New'}</span>
                            </div>
                            <p class="text-xs text-gray-500 mb-3">From: ${s.source || 'Reddit'}</p>
                            <div class="flex gap-2">
                                <a href="https://${s.yupoo_user}.x.yupoo.com" target="_blank" class="flex-1 text-center text-xs bg-blue-500/20 text-blue-400 px-3 py-1.5 rounded hover:bg-blue-500/30">View Yupoo</a>
                            </div>
                        </div>
                    `).join('');
                    emptyEl.classList.add('hidden');
                } else {
                    gridEl.innerHTML = '';
                    emptyEl.classList.remove('hidden');
                }
            } catch (e) {
                console.error('Discovered error:', e);
            }
        }

        // Update facets
        function updateFacets(facets) {
            if (facets.seller) {
                const sel = document.getElementById('seller-filter');
                const current = sel.value;
                sel.innerHTML = '<option value="">All sellers</option>' + facets.seller.map(s => `<option value="${s.value}">${s.value} (${s.count})</option>`).join('');
                sel.value = current;
            }
            if (facets.category) {
                const sel = document.getElementById('category-filter');
                sel.innerHTML = '<option value="">All categories</option>' + facets.category.map(c => `<option value="${c.value}">${c.value}</option>`).join('');
            }
            if (facets.brand) {
                const sel = document.getElementById('brand-filter');
                sel.innerHTML = '<option value="">All brands</option>' + facets.brand.map(b => `<option value="${b.value}">${b.value}</option>`).join('');
            }
        }

        function updatePagination(total) {
            document.getElementById('results-text').textContent = `${total.toLocaleString()} products found`;
            document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prev-btn').disabled = currentPage === 1;
            document.getElementById('next-btn').disabled = currentPage === totalPages;
            pagination.classList.toggle('hidden', totalPages <= 1);
        }

        async function fetchStats() {
            try {
                const res = await fetch(`${API_BASE}/stats`);
                const data = await res.json();
                document.getElementById('stats-text').textContent = `${data.total_products.toLocaleString()} products ‚Ä¢ ${data.total_sellers} sellers`;
            } catch (e) {}
        }

        // Event listeners
        searchForm.addEventListener('submit', e => { e.preventDefault(); currentPage = 1; fetchProducts(); });
        filterBtn.addEventListener('click', () => filtersSidebar.classList.toggle('hidden'));
        automationBtn.addEventListener('click', toggleAutomation);
        document.getElementById('apply-filters').addEventListener('click', () => { currentPage = 1; fetchProducts(); });
        document.getElementById('clear-filters').addEventListener('click', () => {
            searchInput.value = '';
            document.getElementById('seller-filter').value = '';
            document.getElementById('category-filter').value = '';
            document.getElementById('brand-filter').value = '';
            document.getElementById('min-price').value = '';
            document.getElementById('max-price').value = '';
            document.getElementById('has-links-filter').checked = false;
            currentPage = 1;
            fetchProducts();
        });
        document.getElementById('prev-btn').addEventListener('click', () => { if (currentPage > 1) { currentPage--; fetchProducts(); } });
        document.getElementById('next-btn').addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; fetchProducts(); } });

        // Initial load
        fetchStats();
        fetchProducts();
        pollAutomationStatus();
    </script>
</body>
</html>
